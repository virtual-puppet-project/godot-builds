name: All Builds
on: [workflow_dispatch]

env:
  GODOT_REPO: godotengine/godot
  GODOT_REF: 3.5
  GODOT_PATH: godot/

  APPLIER_REPO: virtual-puppet-project/godot-module-applier
  APPLIER_REF: senpai
  APPLIER_PATH: godot-module-applier/

  BUILD_SCRIPTS_REPO: virtual-puppet-project/godot-build-scripts
  BUILD_SCRIPTS_REF: senpai
  BUILD_SCRIPTS_PATH: godot-build-scripts

  LINUX_BINARY_EDITOR: godot.x11.opt.tools.64
  LINUX_BINARY_EDITOR_NAME: Godot_v3.x-stable_linux_x11_editor.64.zip

jobs:
  # build-windows:
  #   runs-on: windows-2019
  #   steps:
  #     - name: Checkout Godot
  #       uses: actions/checkout@v3
  #       with:
  #         repository: ${GODOT_REPO}
  #         ref: ${GODOT_REF}
  #         path: ${GODOT_PATH}
  #     - name: Checkout applier
  #       uses: actions/checkout@v3
  #       with:
  #         repository: ${APPLIER_REPO}
  #         ref: ${APPLIER_REF}
  #         path: ${APPLIER_PATH}

  build-linux:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout Godot
        uses: actions/checkout@v3
        with:
          repository: ${{ env.GODOT_REPO }}
          ref: ${{ env.GODOT_REF }}
          path: ${{ env.GODOT_PATH }}
      - name: Checkout applier
        uses: actions/checkout@v3
        with:
          repository: ${{ env.APPLIER_REPO }}
          ref: ${{ env.APPLIER_REF }}
          path: ${{ env.APPLIER_PATH }}
      - name: Checkout build scripts
        uses: actions/checkout@v3
        with:
          repository: ${{ env.BUILD_SCRIPTS_REPO }}
          ref: ${{ env.BUILD_SCRIPTS_REF }}
          path: ${{ env.BUILD_SCRIPTS_PATH }}
      - name: Install dependencies
        run: sudo apt-get install build-essential scons pkg-config libx11-dev libxcursor-dev libxinerama-dev libgl1-mesa-dev libglu-dev libasound2-dev libpulse-dev libudev-dev libxi-dev libxrandr-dev yasm
      - name: Build
        run: |
          cp ${{ env.APPLIER_PATH }}/applier.py ${{ env.GODOT_PATH }}
          cp ${{ env.APPLIER_PATH }}/modules_file.txt ${{ env.GODOT_PATH }}
          cp ${{ env.BUILD_SCRIPTS_PATH }}/build-* ${{ env.GODOT_PATH }}

          cd ${{ env.GODOT_PATH }}

          python3 applier.py apply

          chmod +x ./build-editor.sh

          ./build-editor.sh
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.LINUX_BINARY_EDITOR_NAME }}
          path: ${{ env.GODOT_PATH }}/bin/${{ env.LINUX_BINARY_EDITOR }}
          if-no-files-found: error
